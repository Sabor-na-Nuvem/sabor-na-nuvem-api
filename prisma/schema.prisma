// --- CONFIGURACAO INICIAL ---
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- MODELOS PRINCIPAIS ---

model Telefone {
  id        Int      @id @default(autoincrement()) @map("idTelefone")
  ddd       String   @db.VarChar(2)
  numero    String   @db.VarChar(9)
  usuarioId String?
  lojaId    Int?
  createdAt DateTime @default(now()) @map("criadoEm")
  updatedAt DateTime @updatedAt @map("atualizadoEm")

  usuario Usuario? @relation(fields: [usuarioId], references: [id], map: "telefone_usuario_fk", onDelete: Cascade)
  loja    Loja?    @relation(fields: [lojaId], references: [id], map: "telefone_loja_fk", onDelete: Cascade)

  @@unique([ddd, numero])
  @@index([usuarioId])
  @@index([lojaId])
  @@map("telefone")
}

model Endereco {
  id              Int           @id @default(autoincrement()) @map("idEndereco")
  cep             String        @db.VarChar(9)
  estado          EstadosBrasil
  cidade          String
  bairro          String
  logradouro      String
  numero          String        @db.VarChar(10)
  complemento     String?
  pontoReferencia String?
  latitude        Decimal?      @db.Decimal(9, 6)
  longitude       Decimal?      @db.Decimal(9, 6)
  createdAt       DateTime      @default(now()) @map("criadoEm")
  updatedAt       DateTime      @updatedAt @map("atualizadoEm")

  usuario Usuario?
  loja    Loja?

  @@index([cep])
  @@map("endereco")
}

model Rede {
  id   Int    @id @default(autoincrement()) @map("idRede")
  nome String @unique @map("nomeRede")
  cnpj String @unique @db.VarChar(14)

  lojas    Loja[]    @relation("LojasDaRede")
  usuarios Usuario[] @relation("AdminRede")

  @@map("rede")
}

model Loja {
  id                   Int      @id @default(autoincrement()) @map("idLoja")
  nome                 String   @map("nomeLoja")
  cnpjFilial           String?  @db.VarChar(14)
  enderecoId           Int      @unique
  horarioFuncionamento String
  ofereceDelivery      Boolean
  raioEntregaKm        Decimal?
  redeId               Int

  createdAt DateTime @default(now()) @map("criadoEm")
  updatedAt DateTime @updatedAt @map("atualizadoEm")

  pedido                 Pedido[]
  funcionarios           Usuario[]           @relation("FuncionarioLoja")
  telefones              Telefone[]
  carrinho               Carrinho[]
  produtosEmEstoque      ProdutosEmLoja[]
  modificadoresEmEstoque ModificadorEmLoja[]

  endereco Endereco @relation(fields: [enderecoId], references: [id], map: "loja_endereco_fk", onDelete: Restrict)
  Rede     Rede     @relation("LojasDaRede", fields: [redeId], references: [id], map: "loja_rede_fk", onDelete: Restrict)

  @@unique([redeId, nome])
  @@map("loja")
}

model Usuario {
  id         String      @id @default(uuid()) @map("idUsuario")
  nome       String      @map("nomeUsuario") @db.VarChar(50)
  email      String      @unique @db.VarChar(255)
  senha      String
  cargo      RoleUsuario @default(CLIENTE)
  enderecoId Int?        @unique

  // --- ADICIONADO PARA O PACOTE DE AUTH ---
  emailVerificado   Boolean            @default(false)
  authTokens        AuthToken[]
  authRefreshTokens AuthRefreshToken[]
  // ----------------------------------------

  // --- RELAÇÕES DE AUTORIZAÇÃO ---
  // TODO: Add checks para lógica abaixo
  // Se o cargo for ADMIN, a qual Rede ele pertence?
  // Se o cargo for FUNCIONARIO, em qual Loja ele trabalha?
  redeId            Int?
  rede              Rede? @relation("AdminRede", fields: [redeId], references: [id], map: "usuario_rede_fk", onDelete: SetNull)
  funcionarioLojaId Int?
  loja              Loja? @relation("FuncionarioLoja", fields: [funcionarioLojaId], references: [id], map: "usuario_loja_fk", onDelete: SetNull)
  // ----------------------------------------

  createdAt DateTime @default(now()) @map("criadoEm")
  updatedAt DateTime @updatedAt @map("atualizadoEm")

  pedido    Pedido[]
  carrinho  Carrinho?
  telefones Telefone[]
  cupons    CupomDesconto[]
  relatorio RelatorioUsuario?

  endereco Endereco? @relation(fields: [enderecoId], references: [id], map: "usuario_endereco_fk", onDelete: SetNull)

  @@index([redeId])
  @@index([funcionarioLojaId])
  @@index([cargo])
  @@map("usuario")
}

model RelatorioUsuario {
  usuarioId             String    @id
  gastosTotais          Decimal   @default(0.0) @db.Decimal(10, 2)
  gastosMensais         Decimal   @default(0.0) @db.Decimal(10, 2)
  qtdTotalPedidos       Int       @default(0)
  qtdMensalPedidos      Int       @default(0)
  dataUltimoPedido      DateTime?
  gastoDesdeUltimoCupom Decimal   @default(0.0) @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("criadoEm")
  updatedAt DateTime @updatedAt @map("atualizadoEm")

  usuario Usuario @relation(fields: [usuarioId], references: [id], map: "relatorio_usuario_fk", onDelete: Cascade)

  @@map("relatorioUsuario")
}

model CupomDesconto {
  id            Int          @id @default(autoincrement()) @map("idCupomDesconto")
  codCupom      String       @unique
  validade      DateTime
  qtdUsos       Int?
  tipoDesconto  TipoDesconto
  valorDesconto Decimal      @db.Decimal(10, 2)
  ativo         Boolean      @default(true)
  usuarioId     String?
  createdAt     DateTime     @default(now()) @map("criadoEm")
  updatedAt     DateTime     @updatedAt @map("atualizadoEm")

  pedido Pedido[]

  usuario Usuario? @relation(fields: [usuarioId], references: [id], map: "cupom_usuario_fk", onDelete: SetNull)

  @@index([usuarioId])
  @@index([codCupom])
  @@map("cupomDesconto")
}

model CategoriaProduto {
  id        Int      @id @default(autoincrement()) @map("idCategoria")
  nome      String   @unique @map("nomeCategoria")
  descricao String?  @map("descricaoCategoria")
  createdAt DateTime @default(now()) @map("criadoEm")
  updatedAt DateTime @updatedAt @map("atualizadoEm")

  produtosNaCategoria Produto[]

  @@map("categoriaProduto")
}

model Produto {
  id          Int      @id @default(autoincrement()) @map("idProduto")
  imagemUrl   String?
  nome        String   @map("nomeProduto")
  descricao   String?  @map("descricaoProduto")
  categoriaId Int
  createdAt   DateTime @default(now()) @map("criadoEm")
  updatedAt   DateTime @updatedAt @map("atualizadoEm")

  vendidoNosPedidos ItemPedido[]
  estaNosCarrinhos  ItemCarrinho[]
  personalizacao    Personalizavel[]
  lojasQueVendem    ProdutosEmLoja[]

  categoria CategoriaProduto @relation(fields: [categoriaId], references: [id], map: "produto_categoria_fk", onDelete: Restrict)

  @@index([categoriaId])
  @@index([nome])
  @@map("produto")
}

model ProdutosEmLoja {
  lojaId           Int
  produtoId        Int
  disponivel       Boolean
  valorBase        Decimal   @db.Decimal(5, 2)
  emPromocao       Boolean
  descontoPromocao Int?
  validadePromocao DateTime?
  createdAt        DateTime  @default(now()) @map("criadoEm")
  updatedAt        DateTime  @updatedAt @map("atualizadoEm")

  loja    Loja    @relation(fields: [lojaId], references: [id], map: "lojaProduto_loja_fk", onDelete: Cascade)
  produto Produto @relation(fields: [produtoId], references: [id], map: "lojaProduto_produto_fk", onDelete: Cascade)

  @@id([lojaId, produtoId])
  @@index([produtoId])
  @@map("produtosEmLoja")
}

model Personalizavel {
  id            Int      @id @default(autoincrement()) @map("idPersonalizavel")
  nome          String   @map("nomePersonalizavel")
  produtoId     Int
  selecaoMinima Int
  selecaoMaxima Int
  createdAt     DateTime @default(now()) @map("criadoEm")
  updatedAt     DateTime @updatedAt @map("atualizadoEm")

  modificadores Modificador[]

  produto Produto @relation(fields: [produtoId], references: [id], map: "personalizavel_produto_fk", onDelete: Cascade)

  @@index([produtoId])
  @@map("personalizavel")
}

model Modificador {
  id                Int      @id @default(autoincrement()) @map("idModificador")
  nome              String   @map("nomeModificador")
  descricao         String?  @map("descricaoModificador")
  ordemVisualizacao Int?
  isOpcaoPadrao     Boolean  @default(false)
  personalizavelId  Int
  createdAt         DateTime @default(now()) @map("criadoEm")
  updatedAt         DateTime @updatedAt @map("atualizadoEm")

  lojasQueDisponibilizam    ModificadorEmLoja[]
  selecionadoNosItensPedido ItemPedidoModificadores[]
  modificadoresEmCarrinho   ItemCarrinhoModificadores[]

  personalizavel Personalizavel @relation(fields: [personalizavelId], references: [id], map: "modificador_personalizavel_fk", onDelete: Cascade)

  @@index([personalizavelId])
  @@map("modificador")
}

model ModificadorEmLoja {
  lojaId         Int
  modificadorId  Int
  disponivel     Boolean
  valorAdicional Decimal  @db.Decimal(4, 2)
  createdAt      DateTime @default(now()) @map("criadoEm")
  updatedAt      DateTime @updatedAt @map("atualizadoEm")

  loja        Loja        @relation(fields: [lojaId], references: [id], map: "lojaMod_loja_fk", onDelete: Cascade)
  modificador Modificador @relation(fields: [modificadorId], references: [id], map: "lojaMod_modificador_fk", onDelete: Cascade)

  @@id([lojaId, modificadorId])
  @@index([modificadorId])
  @@map("modificadorEmLoja")
}

model Pedido {
  id           Int          @id @default(autoincrement()) @map("idPedido")
  clienteId    String?
  lojaId       Int
  dataHora     DateTime     @default(now()) @map("dataHoraPedido")
  valorBase    Decimal      @db.Decimal(7, 2)
  valorCobrado Decimal      @db.Decimal(7, 2)
  cupomUsadoId Int?
  tipo         TipoPedido   @map("tipoPedido")
  observacoes  String?      @map("observacoesPedido")
  status       StatusPedido @default(PENDENTE)
  createdAt    DateTime     @default(now()) @map("criadoEm")
  updatedAt    DateTime     @updatedAt @map("atualizadoEm")

  itensNoPedido ItemPedido[]

  loja    Loja           @relation(fields: [lojaId], references: [id], map: "pedido_loja_fk", onDelete: Restrict)
  cliente Usuario?       @relation(fields: [clienteId], references: [id], map: "pedido_usuario_fk", onDelete: SetNull)
  cupom   CupomDesconto? @relation(fields: [cupomUsadoId], references: [id], map: "pedido_cupom_fk", onDelete: SetNull)

  @@index([cupomUsadoId])
  @@index([clienteId])
  @@index([dataHora])
  @@index([lojaId])
  @@index([status])
  @@index([tipo])
  @@map("pedido")
}

model ItemPedido {
  id                   Int      @id @default(autoincrement()) @map("itemPedidoId")
  pedidoId             Int
  produtoId            Int
  qtdProduto           Int
  valorUnitarioProduto Decimal  @db.Decimal(7, 2)
  createdAt            DateTime @default(now()) @map("criadoEm")
  updatedAt            DateTime @updatedAt @map("atualizadoEm")

  modificadoresSelecionados ItemPedidoModificadores[]

  pedido  Pedido  @relation(fields: [pedidoId], references: [id], map: "itemPedido_pedido_fk", onDelete: Cascade)
  produto Produto @relation(fields: [produtoId], references: [id], map: "itemPedido_produto_fk", onDelete: Restrict)

  @@index([produtoId])
  @@index([pedidoId])
  @@map("itemPedido")
}

model ItemPedidoModificadores {
  itemPedidoId          Int
  modificadorId         Int
  valorAdicionalCobrado Decimal @db.Decimal(4, 2)

  itemPedido  ItemPedido  @relation(fields: [itemPedidoId], references: [id], onDelete: Cascade)
  modificador Modificador @relation(fields: [modificadorId], references: [id], onDelete: Restrict)

  @@id([itemPedidoId, modificadorId])
  @@index([modificadorId])
  @@map("itemPedidoModificadores")
}

model Carrinho {
  id        String     @id @map("idCarrinho")
  tipo      TipoPedido @map("tipoPedido")
  lojaId    Int
  createdAt DateTime   @default(now()) @map("criadoEm")
  updatedAt DateTime   @updatedAt @map("atualizadoEm")

  itensNoCarrinho ItemCarrinho[]

  cliente Usuario @relation(fields: [id], references: [id], map: "carrinho_usuario_fk", onDelete: Cascade)
  loja    Loja    @relation(fields: [lojaId], references: [id], map: "carrinho_loja_fk", onDelete: Cascade)

  @@index([lojaId])
  @@map("carrinho")
}

model ItemCarrinho {
  id                   Int      @id @default(autoincrement()) @map("idItemCarrinho")
  carrinhoId           String
  produtoId            Int
  qtdProduto           Int      @default(1)
  valorUnitarioProduto Decimal  @db.Decimal(7, 2)
  createdAt            DateTime @default(now()) @map("criadoEm")
  updatedAt            DateTime @updatedAt @map("atualizadoEm")

  modificadoresSelecionados ItemCarrinhoModificadores[]

  produto  Produto  @relation(fields: [produtoId], references: [id], map: "itemCarrinho_produto_fk", onDelete: Cascade)
  carrinho Carrinho @relation(fields: [carrinhoId], references: [id], map: "itemCarrinho_carrinho_fk", onDelete: Cascade)

  @@index([produtoId])
  @@index([carrinhoId])
  @@map("itemCarrinho")
}

model ItemCarrinhoModificadores {
  itemCarrinhoId        Int
  modificadorId         Int
  valorAdicionalCobrado Decimal @db.Decimal(4, 2)

  modificador  Modificador  @relation(fields: [modificadorId], references: [id], onDelete: Restrict)
  itemCarrinho ItemCarrinho @relation(fields: [itemCarrinhoId], references: [id], onDelete: Cascade)

  @@id([itemCarrinhoId, modificadorId])
  @@index([modificadorId])
  @@map("itemCarrinhoModificadores")
}

// --- ADICIONADO PARA O PACOTE DE AUTH ---

model AuthToken {
  id        String        @id @default(uuid())
  token     String        @unique
  tipo      AuthTokenType
  expiresAt DateTime
  usado     Boolean       @default(false)
  payload   Json?

  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([usuarioId])
  @@index([expiresAt])
  @@index([tipo])
  @@map("authToken")
}

model AuthRefreshToken {
  id            String   @id @default(uuid())
  selector      String   @unique
  validatorHash String
  expiresAt     DateTime
  revogado      Boolean  @default(false)

  usuarioId String
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([usuarioId])
  @@index([expiresAt])
  @@map("authRefreshToken")
}

// --- ENUMs ---

enum AuthTokenType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
  EMAIL_UPDATE
}

enum EstadosBrasil {
  AC
  AL
  AP
  AM
  BA
  CE
  DF
  ES
  GO
  MA
  MT
  MS
  MG
  PA
  PB
  PR
  PE
  PI
  RJ
  RN
  RS
  RO
  RR
  SC
  SP
  SE
  TO
}

enum RoleUsuario {
  CLIENTE
  FUNCIONARIO
  ADMIN
}

enum TipoDesconto {
  PERCENTUAL // Ex: 10 (para 10%)
  VALOR_FIXO // Ex: 15.50 (para R$ 15,50)
}

enum TipoPedido {
  ENTREGA
  RETIRADA
}

enum StatusPedido {
  CANCELADO
  AGUARDANDO_PAGAMENTO
  PENDENTE
  EM_PREPARO
  PRONTO_PARA_ENTREGA
  PRONTO_PARA_RETIRADA
  EM_ENTREGA
  REALIZADO
}
