// --- CONFIGURACAO INICIAL ---
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- MODELOS PRINCIPAIS ---

model Telefone {
  id        Int      @id @default(autoincrement()) @map("idTelefone")
  ddd       String   @db.VarChar(2)
  numero    String   @db.VarChar(9)
  usuarioId String?
  lojaId    Int?
  // Timestamps
  createdAt DateTime @default(now()) @map("criadoEm")
  updatedAt DateTime @updatedAt @map("atualizadoEm")

  usuario Usuario? @relation(fields: [usuarioId], references: [id], map: "telefone_usuario_fk", onDelete: Cascade)
  loja    Loja?    @relation(fields: [lojaId], references: [id], map: "telefone_loja_fk", onDelete: Cascade)

  @@unique([ddd, numero])
  @@map("telefone")
}

model Endereco {
  id              Int           @id @default(autoincrement()) @map("idEndereco")
  cep             String        @db.VarChar(9)
  estado          EstadosBrasil
  cidade          String
  bairro          String
  logradouro      String
  numero          String        @db.VarChar(10)
  complemento     String?
  pontoReferencia String?
  latitude        Decimal       @db.Decimal(9, 6)
  longitude       Decimal       @db.Decimal(9, 6)
  // Timestamps
  createdAt       DateTime      @default(now()) @map("criadoEm")
  updatedAt       DateTime      @updatedAt @map("atualizadoEm")

  usuario Usuario?
  loja    Loja?

  @@map("endereco")
}

model Loja {
  id                   Int      @id @default(autoincrement()) @map("idLoja")
  nome                 String   @unique @map("nomeLoja")
  cnpj                 String   @unique @db.VarChar(14)
  enderecoId           Int      @unique
  horarioFuncionamento String
  ofereceDelivery      Boolean
  raioEntregaKm        Decimal?
  // Timestamps
  createdAt            DateTime @default(now()) @map("criadoEm")
  updatedAt            DateTime @updatedAt @map("atualizadoEm")

  Pedido                 Pedido[]
  funcionarios           Usuario[]
  telefones              Telefone[]
  produtosEmEstoque      ProdutosEmLoja[]
  modificadoresEmEstoque ModificadorEmLoja[]

  endereco Endereco @relation(fields: [enderecoId], references: [id], map: "loja_endereco_fk", onDelete: Restrict)

  @@map("loja")
}

model Usuario {
  id                String      @id @default(uuid()) @map("idUsuario")
  nome              String      @map("nomeUsuario") @db.VarChar(50)
  email             String      @unique @db.VarChar(30)
  cargo             RoleUsuario @default(CLIENTE)
  enderecoId        Int?        @unique
  funcionarioLojaId Int?
  // Timestamps
  createdAt         DateTime    @default(now()) @map("criadoEm")
  updatedAt         DateTime    @updatedAt @map("atualizadoEm")

  Pedido    Pedido[]
  carrinho  Carrinho?
  telefones Telefone[]
  cupons    CupomDesconto[]
  relatorio RelatorioUsuario?

  endereco Endereco? @relation(fields: [enderecoId], references: [id], map: "usuario_endereco_fk", onDelete: SetNull)
  loja     Loja?     @relation(fields: [funcionarioLojaId], references: [id], map: "usuario_loja_fk", onDelete: SetNull)

  @@map("usuario")
}

model RelatorioUsuario {
  usuarioId        String   @id
  gastosTotais     Decimal  @db.Decimal(10, 2)
  gastosMensais    Decimal  @db.Decimal(10, 2)
  qtdTotalPedidos  Int
  qtdMensalPedidos Int
  // Timestamps
  createdAt        DateTime @default(now()) @map("criadoEm")
  updatedAt        DateTime @updatedAt @map("atualizadoEm")

  usuario Usuario @relation(fields: [usuarioId], references: [id], map: "relatorio_usuario_fk", onDelete: Cascade)

  @@map("relatorioUsuario")
}

model CupomDesconto {
  id        Int      @id @default(autoincrement()) @map("idCupomDesconto")
  codCupom  String   @unique
  validade  DateTime
  qtdUsos   Int
  ativo     Boolean  @default(true)
  usuarioId String?
  // Timestamps
  createdAt DateTime @default(now()) @map("criadoEm")
  updatedAt DateTime @updatedAt @map("atualizadoEm")

  Pedido Pedido[]

  usuario Usuario? @relation(fields: [usuarioId], references: [id], map: "cupom_usuario_fk", onDelete: SetNull)

  @@map("cupomDesconto")
}

model CategoriaProduto {
  id        Int      @id @default(autoincrement()) @map("idCategoria")
  nome      String   @unique @map("nomeCategoria")
  descricao String   @map("descricaoCategoria")
  // Timestamps
  createdAt DateTime @default(now()) @map("criadoEm")
  updatedAt DateTime @updatedAt @map("atualizadoEm")

  produtosNaCategoria Produto[]

  @@map("categoriaProduto")
}

model Produto {
  id          Int      @id @default(autoincrement()) @map("idProduto")
  imagemUrl   String
  nome        String   @map("nomeProduto")
  descricao   String   @map("descricaoProduto")
  categoriaId Int
  // Timestamps
  createdAt   DateTime @default(now()) @map("criadoEm")
  updatedAt   DateTime @updatedAt @map("atualizadoEm")

  vendidoNosPedidos ItemPedido[]
  estaNosCarrinhos  ItemCarrinho[]
  personalizacao    Personalizavel[]
  lojasQueVendem    ProdutosEmLoja[]

  categoria CategoriaProduto @relation(fields: [categoriaId], references: [id], map: "produto_categoria_fk", onDelete: Restrict)

  @@map("produto")
}

model ProdutosEmLoja {
  lojaId           Int
  produtoId        Int
  disponivel       Boolean
  valorBase        Decimal  @db.Decimal(5, 2)
  emPromocao       Boolean
  descontoPromocao Int
  validadePromocao DateTime
  // Timestamps
  createdAt        DateTime @default(now()) @map("criadoEm")
  updatedAt        DateTime @updatedAt @map("atualizadoEm")

  loja    Loja    @relation(fields: [lojaId], references: [id], map: "lojaProduto_loja_fk", onDelete: Cascade)
  produto Produto @relation(fields: [produtoId], references: [id], map: "lojaProduto_produto_fk", onDelete: Cascade)

  @@id([lojaId, produtoId])
  @@map("produtosEmLoja ")
}

model Personalizavel {
  id            Int      @id @default(autoincrement()) @map("idPersonalizavel")
  nome          String   @map("nomePersonalizavel")
  produtoId     Int
  selecaoMinima Int
  selecaoMaxima Int
  // Timestamps
  createdAt     DateTime @default(now()) @map("criadoEm")
  updatedAt     DateTime @updatedAt @map("atualizadoEm")

  modificadores Modificador[]

  produto Produto @relation(fields: [produtoId], references: [id], map: "personalizavel_produto_fk", onDelete: Cascade)

  @@map("personalizavel")
}

model Modificador {
  id               Int      @id @default(autoincrement()) @map("idModificador")
  nome             String   @map("nomeModificador")
  personalizavelId Int
  // Timestamps
  createdAt        DateTime @default(now()) @map("criadoEm")
  updatedAt        DateTime @updatedAt @map("atualizadoEm")

  lojasQueDisponibilizam ModificadorEmLoja[]

  personalizavel Personalizavel @relation(fields: [personalizavelId], references: [id], map: "modificador_personalizavel_fk", onDelete: Cascade)

  @@map("modificador")
}

model ModificadorEmLoja {
  lojaId         Int
  modificadorId  Int
  disponivel     Boolean
  valorAdicional Decimal  @db.Decimal(4, 2)
  // Timestamps
  createdAt      DateTime @default(now()) @map("criadoEm")
  updatedAt      DateTime @updatedAt @map("atualizadoEm")

  loja        Loja        @relation(fields: [lojaId], references: [id], map: "lojaMod_loja_fk", onDelete: Cascade)
  modificador Modificador @relation(fields: [modificadorId], references: [id], map: "lojaMod_modificador_fk", onDelete: Cascade)

  @@id([lojaId, modificadorId])
  @@map("modificadorEmLoja")
}

model Pedido {
  id           Int          @id @default(autoincrement()) @map("idPedido")
  clienteId    String?
  lojaId       Int
  dataHora     DateTime     @map("dataHoraPedido")
  valorBase    Decimal      @db.Decimal(7, 2)
  valorCobrado Decimal      @db.Decimal(7, 2)
  cupomUsadoId Int?
  tipo         TipoPedido   @map("tipoPedido")
  observacoes  String?      @map("observacoesPedido")
  status       StatusPedido
  // Timestamps
  createdAt    DateTime     @default(now()) @map("criadoEm")
  updatedAt    DateTime     @updatedAt @map("atualizadoEm")

  itensNoPedido ItemPedido[]

  loja    Loja           @relation(fields: [lojaId], references: [id], map: "pedido_loja_fk", onDelete: Restrict)
  cliente Usuario?       @relation(fields: [clienteId], references: [id], map: "pedido_usuario_fk", onDelete: SetNull)
  cupom   CupomDesconto? @relation(fields: [cupomUsadoId], references: [id], map: "pedido_cupom_fk", onDelete: SetNull)

  @@map("pedido")
}

model ItemPedido {
  pedidoId           Int
  produtoId          Int
  qtdProduto         Int
  valorTotalProdutos Decimal  @db.Decimal(7, 2)
  // Timestamps
  createdAt          DateTime @default(now()) @map("criadoEm")
  updatedAt          DateTime @updatedAt @map("atualizadoEm")

  pedido  Pedido  @relation(fields: [pedidoId], references: [id], map: "itemPedido_pedido_fk", onDelete: Cascade)
  produto Produto @relation(fields: [produtoId], references: [id], map: "itemPedido_produto_fk", onDelete: Restrict)

  @@id([pedidoId, produtoId])
  @@map("itemPedido")
}

model Carrinho {
  id        String     @id @map("idCarrinho")
  tipo      TipoPedido @map("tipoPedido")
  valorBase Decimal    @db.Decimal(7, 2)
  // Timestamps
  createdAt DateTime   @default(now()) @map("criadoEm")
  updatedAt DateTime   @updatedAt @map("atualizadoEm")

  itensNoCarrinho ItemCarrinho[]

  cliente Usuario @relation(fields: [id], references: [id], map: "carrinho_usuario_fk", onDelete: Cascade)

  @@map("carrinho")
}

model ItemCarrinho {
  carrinhoId         String
  produtoId          Int
  qtdProduto         Int
  valorTotalProdutos Decimal  @db.Decimal(7, 2)
  // Timestamps
  createdAt          DateTime @default(now()) @map("criadoEm")
  updatedAt          DateTime @updatedAt @map("atualizadoEm")

  carrinho Carrinho @relation(fields: [carrinhoId], references: [id], map: "itemCarrinho_carrinho_fk", onDelete: Cascade)
  produto  Produto  @relation(fields: [produtoId], references: [id], map: "itemCarrinho_produto_fk", onDelete: Cascade)

  @@id([carrinhoId, produtoId])
  @@map("itemCarrinho")
}

// --- ENUMs ---

enum EstadosBrasil {
  AC
  AL
  AP
  AM
  BA
  CE
  DF
  ES
  GO
  MA
  MT
  MS
  MG
  PA
  PB
  PR
  PE
  PI
  RJ
  RN
  RS
  RO
  RR
  SC
  SP
  SE
  TO
}

enum RoleUsuario {
  CLIENTE
  FUNCIONARIO
  ADMIN
}

enum TipoPedido {
  ENTREGA
  RETIRADA
}

enum StatusPedido {
  CANCELADO
  AGUARDANDO_PAGAMENTO
  PENDENTE
  EM_PREPARO
  PRONTO_PARA_ENTREGA
  PRONTO_PARA_RETIRADA
  EM_ENTREGA
  REALIZADO
}
